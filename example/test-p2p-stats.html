<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Stats Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
        }
        .stats-container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }
        .stat-label {
            font-weight: bold;
            color: #555;
        }
        .stat-value {
            color: #000;
        }
        .channel-stats {
            margin-top: 20px;
            padding: 10px;
            background: #fff;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 14px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background: #0056b3;
        }
        button.secondary {
            background: #6c757d;
        }
        button.secondary:hover {
            background: #545b62;
        }
        .controls {
            margin: 20px 0;
        }
        .warning {
            color: #ff0000;
            font-weight: bold;
            padding: 10px;
            background: #ffeeee;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #00aa00;
            font-weight: bold;
            padding: 10px;
            background: #eeffee;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>P2P Networking Stats Test</h1>
    
    <div class="controls">
        <button onclick="refreshStats()">Refresh Stats</button>
        <button onclick="resetStats()" class="secondary">Reset Stats</button>
        <button onclick="enableStats()">Enable Stats</button>
        <button onclick="disableStats()" class="secondary">Disable Stats</button>
    </div>

    <div id="status"></div>
    
    <div class="stats-container">
        <h2>P2P Network Statistics</h2>
        <div id="stats-content">
            <p>Click "Refresh Stats" to view current statistics</p>
        </div>
    </div>

    <div class="controls">
        <h3>Test Message Sending (requires active lobby)</h3>
        <button onclick="sendTestMessage()">Send Test Message</button>
        <button onclick="sendBroadcast()">Send Broadcast</button>
    </div>

    <script>
        // Instructions for using the P2P stats in console
        console.log(`
===========================================
P2P Stats Console Commands:
===========================================

// Get current stats
window.WavedashJS.getP2PStats()

// Reset stats
window.WavedashJS.resetP2PStats()

// Enable stats tracking
window.WavedashJS.enableP2PStats()

// Disable stats tracking
window.WavedashJS.disableP2PStats()

===========================================
`);

        function refreshStats() {
            if (!window.WavedashJS) {
                showStatus('WavedashJS not initialized', 'warning');
                return;
            }

            try {
                const stats = window.WavedashJS.getP2PStats();
                displayStats(stats);
                showStatus('Stats refreshed successfully', 'success');
            } catch (error) {
                showStatus('Error: ' + error.message, 'warning');
            }
        }

        function resetStats() {
            if (!window.WavedashJS) {
                showStatus('WavedashJS not initialized', 'warning');
                return;
            }

            try {
                window.WavedashJS.resetP2PStats();
                refreshStats();
                showStatus('Stats reset successfully', 'success');
            } catch (error) {
                showStatus('Error: ' + error.message, 'warning');
            }
        }

        function enableStats() {
            if (!window.WavedashJS) {
                showStatus('WavedashJS not initialized', 'warning');
                return;
            }

            try {
                window.WavedashJS.enableP2PStats();
                showStatus('Stats tracking enabled', 'success');
            } catch (error) {
                showStatus('Error: ' + error.message, 'warning');
            }
        }

        function disableStats() {
            if (!window.WavedashJS) {
                showStatus('WavedashJS not initialized', 'warning');
                return;
            }

            try {
                window.WavedashJS.disableP2PStats();
                showStatus('Stats tracking disabled', 'success');
            } catch (error) {
                showStatus('Error: ' + error.message, 'warning');
            }
        }

        function sendTestMessage() {
            if (!window.WavedashJS) {
                showStatus('WavedashJS not initialized', 'warning');
                return;
            }

            try {
                // Create test payload
                const testData = new TextEncoder().encode('Test message: ' + Date.now());
                const success = window.WavedashJS.broadcastP2PMessage(0, true, testData);
                
                if (success) {
                    showStatus('Test message sent successfully', 'success');
                } else {
                    showStatus('Failed to send message (no peers ready?)', 'warning');
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'warning');
            }
        }

        function sendBroadcast() {
            if (!window.WavedashJS) {
                showStatus('WavedashJS not initialized', 'warning');
                return;
            }

            try {
                // Send multiple messages to generate stats
                let successCount = 0;
                for (let i = 0; i < 10; i++) {
                    const testData = new TextEncoder().encode('Broadcast message #' + i + ': ' + Date.now());
                    if (window.WavedashJS.broadcastP2PMessage(i % 4, true, testData)) {
                        successCount++;
                    }
                }
                
                showStatus(`Sent ${successCount}/10 broadcast messages`, 'success');
                setTimeout(refreshStats, 100);
            } catch (error) {
                showStatus('Error: ' + error.message, 'warning');
            }
        }

        function displayStats(stats) {
            const container = document.getElementById('stats-content');
            
            if (!stats.enabled) {
                container.innerHTML = '<p class="warning">Stats tracking is currently disabled. Enable it in the init config or by calling enableP2PStats()</p>';
                return;
            }

            let html = '';
            
            // General stats
            html += '<div class="stat-row"><span class="stat-label">Stats Enabled:</span><span class="stat-value">' + stats.enabled + '</span></div>';
            html += '<div class="stat-row"><span class="stat-label">Total Packets Sent:</span><span class="stat-value">' + stats.totalPacketsSent + '</span></div>';
            html += '<div class="stat-row"><span class="stat-label">Total Packets Received:</span><span class="stat-value">' + stats.totalPacketsReceived + '</span></div>';
            html += '<div class="stat-row"><span class="stat-label">Total Bytes Received:</span><span class="stat-value">' + stats.totalBytesReceived.toLocaleString() + ' bytes</span></div>';
            
            // Queue stats
            html += '<h3>Queue Statistics</h3>';
            html += '<div class="stat-row"><span class="stat-label">Current Queue Size:</span><span class="stat-value">' + stats.currentQueueSize + ' / ' + stats.maxQueueSize + '</span></div>';
            html += '<div class="stat-row"><span class="stat-label">Queue Utilization:</span><span class="stat-value">' + stats.queueUtilizationPercent.toFixed(2) + '%</span></div>';
            html += '<div class="stat-row"><span class="stat-label">Avg Queue Wait Time:</span><span class="stat-value">' + stats.averageQueueWaitTimeMs.toFixed(2) + ' ms</span></div>';
            html += '<div class="stat-row"><span class="stat-label">Max Queue Wait Time:</span><span class="stat-value">' + stats.maxQueueWaitTimeMs.toFixed(2) + ' ms</span></div>';
            html += '<div class="stat-row"><span class="stat-label">Min Queue Wait Time:</span><span class="stat-value">' + stats.minQueueWaitTimeMs.toFixed(2) + ' ms</span></div>';
            
            // Packet size stats
            html += '<h3>Packet Size Statistics</h3>';
            html += '<div class="stat-row"><span class="stat-label">Avg Packet Size:</span><span class="stat-value">' + stats.averagePacketSizeBytes.toFixed(2) + ' bytes</span></div>';
            html += '<div class="stat-row"><span class="stat-label">Max Packet Size:</span><span class="stat-value">' + stats.maxPacketSizeBytes + ' bytes</span></div>';
            html += '<div class="stat-row"><span class="stat-label">Min Packet Size:</span><span class="stat-value">' + stats.minPacketSizeBytes + ' bytes</span></div>';
            
            // Channel stats
            if (Object.keys(stats.channelStats).length > 0) {
                html += '<div class="channel-stats">';
                html += '<h3>Per-Channel Statistics</h3>';
                for (const [channel, channelData] of Object.entries(stats.channelStats)) {
                    html += '<div class="stat-row">';
                    html += '<span class="stat-label">Channel ' + channel + ':</span>';
                    html += '<span class="stat-value">' + channelData.messagesInQueue + ' / ' + channelData.queueCapacity + ' messages</span>';
                    html += '</div>';
                }
                html += '</div>';
            } else {
                html += '<p><i>No per-channel data available yet</i></p>';
            }
            
            container.innerHTML = html;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<div class="' + type + '">' + message + '</div>';
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        // Auto-refresh stats every 2 seconds if enabled
        setInterval(() => {
            if (window.WavedashJS) {
                try {
                    const stats = window.WavedashJS.getP2PStats();
                    if (stats.enabled) {
                        displayStats(stats);
                    }
                } catch (error) {
                    // Silently fail during auto-refresh
                }
            }
        }, 2000);
    </script>
</body>
</html>
